# 批量圖片資料處理系統使用指南

本系統用於處理批量圖片資料，包括資料收集、標籤提取、資料庫儲存和向量搜尋功能。

## 📋 目錄
- [系統概述](#系統概述)
- [系統架構](#系統架構)
- [前置需求](#前置需求)
- [安裝步驟](#安裝步驟)
- [環境配置](#環境配置)
- [標準工作流程](#標準工作流程)
- [進階功能](#進階功能)
- [資料結構說明](#資料結構說明)
- [故障排除](#故障排除)
- [效能優化建議](#效能優化建議)

## 🔍 系統概述

本系統提供完整的圖片資料處理和向量搜尋解決方案：
1. **資料匯入**：將 JSON 格式的圖片 metadata 匯入 PostgreSQL
2. **向量索引**：基於 prompt 和 description 創建雙重向量索引
3. **語義搜尋**：支援多條件篩選的向量相似度搜尋
4. **資料管理**：自動同步、去重和資料清理

### 工作流程
```
JSON 檔案 → PostgreSQL → Pinecone (雙 namespace) → 向量搜尋
```

## 🏗️ 系統架構

```
batch_image/
├── data/                           # 資料目錄
│   ├── json/                      # JSON 格式資料檔案
│   ├── media/                     # 媒體檔案（音頻、視頻）
│   └── text/                      # 文字檔案
├── src/                           # 原始碼目錄
│   ├── database/                  # 資料庫相關模組
│   │   ├── pinecone_handler.py   # Pinecone 向量資料庫操作
│   │   └── postgres_handler.py   # PostgreSQL 資料庫操作
│   ├── scripts/                   # 核心執行腳本
│   │   ├── import_json_to_postgres.py    # JSON 資料匯入
│   │   ├── upload_postgres_to_pinecone.py # 上傳到向量資料庫
│   │   └── delete_pinecone_data.py        # 刪除向量資料
│   ├── utils/                     # 工具函數
│   │   ├── add_file_paths.py     # 添加檔案路徑
│   │   └── retrieve_tags.py      # 標籤提取
│   ├── examples/                  # 使用範例
│   └── generators/                # 內容生成器
├── batch_image_data_*.json        # 批量圖片資料檔案
└── workflows/                     # 工作流程定義
```

## 📦 前置需求

- Python 3.8+
- PostgreSQL 資料庫 (連線正常)
- Pinecone 帳號和 API 金鑰
- Azure OpenAI API 存取權限
- 網路連線 (存取外部 API)

## 🚀 安裝步驟

1. 進入專案目錄：
```bash
cd batch_image
```

2. 建立虛擬環境（推薦）：
```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
```

3. 安裝相依套件：
```bash
pip install -r requirements.txt
```

## ⚙️ 環境配置

### 環境變數設定 (創建 `.env` 檔案)
```env
# Pinecone 向量資料庫
PINECONE_API_KEY=your_pinecone_api_key

# Azure OpenAI (用於向量生成)
AZURE_OPENAI_API_KEY=your_azure_openai_key
AZURE_OPENAI_ENDPOINT=your_azure_openai_endpoint

# NVIDIA API (可選)
NVIDIA_API_KEY=your_nvidia_api_key
```

## 📖 標準工作流程

### 1. 資料匯入到 PostgreSQL
將根目錄下的 `batch_image_data_*_final.json` 檔案匯入資料庫：

```bash
python src/scripts/import_json_to_postgres.py
```

**功能說明：**
- 自動搜尋根目錄下所有符合模式的 JSON 檔案
- 解析 JSON 數據並格式化為資料庫記錄
- 使用 `ON CONFLICT` 處理重複記錄
- 顯示詳細的匯入統計

### 2. 上傳到 Pinecone 向量資料庫
自動上傳到兩個 namespace 進行向量索引：

```bash
python src/scripts/upload_postgres_to_pinecone.py
```

**雙 Namespace 架構：**
- `prompt` namespace：基於 prompt 內容的向量搜尋
- `description` namespace：基於 tags/description 的向量搜尋

**功能特色：**
- 自動處理各種 prompt 格式（包括嵌套 JSON）
- 批量上傳提升效率
- 自動錯誤處理和重試機制
- 詳細的上傳進度和統計

### 3. 資料查詢和搜尋

#### Python API 使用範例：

```python
from src.database.pinecone_handler import PineconeHandler

handler = PineconeHandler()

# 基於 prompt 的語義搜尋
results = handler.query_pinecone(
    query="bull market investment strategy",
    metadata_filter={"sub_theme": "BULLISH"},
    index_name="image-library",
    namespace="prompt",
    top_k=5
)

# 基於 description/tags 的搜尋
results = handler.query_pinecone(
    query="office building cityscape",
    metadata_filter={"theme": "lens_quant"},
    index_name="image-library", 
    namespace="description",
    top_k=5
)

# 混合搜尋 - 多條件篩選
results = handler.query_pinecone(
    query="financial growth",
    metadata_filter={
        "$and": [
            {"sub_theme": {"$in": ["BULLISH", "WALLSTREET"]}},
            {"theme": {"$eq": "lens_quant"}}
        ]
    },
    index_name="image-library",
    namespace="prompt",
    top_k=10
)
```

## 🔧 進階功能

### 資料清理
根據條件批量刪除 Pinecone 中的向量：

```bash
# 編輯 src/scripts/delete_pinecone_data.py 中的刪除條件
python src/scripts/delete_pinecone_data.py
```

### 檔案路徑管理
為 JSON 資料添加檔案路徑資訊：

```bash
python src/utils/add_file_paths.py
```

### 標籤批量提取
使用 AI 批量提取圖片標籤：

```bash
python src/utils/retrieve_tags.py
```

## 📊 資料結構說明

### PostgreSQL 表結構 (image_library)
```sql
CREATE TABLE image_library (
    id UUID PRIMARY KEY,                -- 唯一識別碼
    name VARCHAR(255),                  -- 檔案名稱
    file_path TEXT,                     -- 檔案完整路徑
    prompt TEXT,                        -- 原始 prompt (JSON 格式)
    description TEXT,                   -- 標籤和描述
    theme VARCHAR(100),                 -- 主題分類 (如: lens_quant)
    sub_theme VARCHAR(100),             -- 子主題 (如: BULLISH, CRYPTO)
    status VARCHAR(50) DEFAULT 'active' -- 記錄狀態
);
```

### Pinecone 向量記錄結構
```python
{
    "id": "uuid-string",
    "values": [512維向量數組],
    "metadata": {
        "name": "圖片檔案名稱",
        "file_path": "完整檔案路徑", 
        "description": "標籤和描述內容",
        "theme": "主題分類",
        "sub_theme": "子主題分類",
        "original_prompt": "原始prompt前500字符"
    }
}
```

### JSON 輸入格式範例
```json
{
  "BULLISH": [
    {
      "task_id": "uuid-here",
      "prompt": "{\"prompt\": {\"description\": \"bull market scene\"}}",
      "file_name": "batch_bullish_2025-08-04_14-25-02-0001",
      "tags": "finance, market, growth, success",
      "file_path": "C:\\path\\to\\image.png"
    }
  ]
}
```

## 🔧 故障排除

### 常見問題及解決方案

#### 1. 資料庫連線失敗
```bash
# 錯誤訊息：connection failed
```
**解決步驟：**
- 檢查網路連線狀態
- 驗證資料庫伺服器是否運行
- 確認連線參數正確 (host, port, 憑證)
- 檢查防火牆和安全組設定

#### 2. Pinecone 上傳失敗
```bash
# 錯誤訊息：Vector dimension 0 does not match
```
**解決步驟：**
- 驗證 AZURE_OPENAI_API_KEY 有效性
- 檢查網路連線到 Azure OpenAI
- 確認向量維度設定為 512
- 檢查 prompt 提取是否正常

#### 3. JSON 格式錯誤
```bash
# 錯誤訊息：JSONDecodeError
```
**解決步驟：**
- 使用 JSON 驗證工具檢查檔案格式
- 確認檔案編碼為 UTF-8
- 檢查是否有特殊字符或轉義問題

#### 4. 記憶體不足錯誤
```bash
# 錯誤訊息：MemoryError 或 OOM
```
**解決步驟：**
- 降低 batch_size 參數 (預設 50 → 25)
- 分批處理大型資料集
- 增加系統虛擬記憶體

### 除錯技巧

#### 1. 檢查資料同步狀態
```python
from src.database.pinecone_handler import PineconeHandler

handler = PineconeHandler()

# 檢查 PostgreSQL 記錄數
data = handler.fetch_image_library_data()
print(f"PostgreSQL 總記錄數: {len(data)}")

# 檢查 Pinecone 向量統計
index = handler._pc.Index("image-library")
stats = index.describe_index_stats()
for ns_name, ns_stats in stats.namespaces.items():
    print(f"{ns_name} namespace: {ns_stats.vector_count} vectors")
```

#### 2. 測試 Prompt 提取功能
```python
# 測試 prompt 提取是否正常
sample_prompt = '{"prompt": {"description": "test content"}}'
extracted = handler.extract_prompt_from_json(sample_prompt)
print(f"提取結果類型: {type(extracted)}")
print(f"提取內容: {extracted}")
```

#### 3. 驗證向量搜尋
```python
# 測試搜尋功能
test_results = handler.query_pinecone(
    query="test search",
    metadata_filter={},
    index_name="image-library",
    namespace="prompt",
    top_k=1
)
print(f"搜尋結果數量: {len(test_results)}")
```

## ⚡ 效能優化建議

### 1. 批量處理參數調整
```python
# 根據系統資源調整批量大小
- 記憶體充足: batch_size=50-100
- 記憶體有限: batch_size=25-50
- 網路不穩: batch_size=10-25
```

### 2. 網路優化策略
- 選擇地理位置接近的資料庫區域
- 使用穩定的網路連線
- 考慮 CDN 或代理伺服器

### 3. 資料預處理
- 確保 JSON 格式正確無誤
- 預先驗證必要欄位完整性
- 移除不必要的大型檔案

### 4. 監控和維護
```python
# 定期檢查系統狀態
import psutil
print(f"CPU 使用率: {psutil.cpu_percent()}%")
print(f"記憶體使用: {psutil.virtual_memory().percent}%")
```

## 🔄 系統維護

### 定期維護任務

#### 1. 資料備份
```bash
# PostgreSQL 備份
pg_dump -h host -U user -d database > backup.sql

# 原始檔案備份
tar -czf json_backup.tar.gz batch_image_data_*.json
```

#### 2. 效能監控
- 監控 API 使用量和配額
- 追蹤向量搜尋回應時間
- 檢查資料庫查詢效能

#### 3. 資料清理
- 定期清理無效記錄
- 移除重複向量索引
- 最佳化資料庫索引

### 更新和擴展

#### 新增資料時
```bash
# 標準流程
python src/scripts/import_json_to_postgres.py
python src/scripts/upload_postgres_to_pinecone.py
```

#### 資料格式變更時
- 更新 `extract_prompt_from_json` 方法
- 調整資料庫 schema（如需要）
- 重新索引現有資料

## 📞 技術支援

如遇到技術問題，請按以下順序排查：
1. 檢查系統日誌和錯誤訊息
2. 驗證環境變數和憑證
3. 測試網路連線和 API 存取
4. 查閱本文件的故障排除章節
5. 檢查各模組的程式碼註解

更多技術細節請參考 `src/` 目錄下各模組的 docstring 和程式碼註解。